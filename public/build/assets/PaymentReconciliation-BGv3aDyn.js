import{r as l,j as e,H as T,a as b}from"./app-CajWK6Yg.js";import{A as P}from"./AuthenticatedLayout-SZSmBfqU.js";import"./transition-4TztYPwI.js";function A({pendingPayments:m,paidPayments:p,stats:u}){const[j,g]=l.useState({}),[d,o]=l.useState({}),[N,f]=l.useState(!1),[i,c]=l.useState({}),[r,h]=l.useState(null),[x,y]=l.useState("pending"),k=async s=>{g(t=>({...t,[s]:!0}));try{const a=await(await fetch(route("admin.payment-reconciliation.check"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({child_id:s})})).json();c(n=>({...n,[s]:a}))}catch(t){c(a=>({...a,[s]:{error:t.message}}))}g(t=>({...t,[s]:!1}))},v=async s=>{o(t=>({...t,[s]:!0}));try{const a=await(await fetch(route("admin.payment-reconciliation.fix"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({child_id:s})})).json();a.success?b.reload():c(n=>({...n,[s]:{error:a.error}}))}catch(t){c(a=>({...a,[s]:{error:t.message}}))}o(t=>({...t,[s]:!1}))},z=async()=>{if(confirm("Ini akan menyemak SEMUA pembayaran pending dengan ToyyibPay dan memperbaiki status yang tidak sepadan. Teruskan?")){f(!0),h(null);try{const t=await(await fetch(route("admin.payment-reconciliation.bulk"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}})).json();h(t),t.fixed>0&&setTimeout(()=>{b.reload()},3e3)}catch(s){h({error:s.message})}f(!1)}},S=async(s,t)=>{if(confirm(`Anda pasti mahu MANUAL FIX pembayaran untuk ${t}?

Ini akan menandakan pembayaran sebagai SELESAI walaupun API ToyyibPay tidak mengembalikan data.

Pastikan anda mempunyai bukti pembayaran (email/resit).`)){o(a=>({...a,[s]:!0}));try{const n=await(await fetch(route("admin.payment-reconciliation.manual-fix"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({child_id:s})})).json();n.success?(alert("âœ… "+n.message),b.reload()):c(w=>({...w,[s]:{error:n.error}}))}catch(a){c(n=>({...n,[s]:{error:a.message}}))}o(a=>({...a,[s]:!1}))}};return e.jsxs(P,{children:[e.jsx(T,{title:"Payment Reconciliation"}),e.jsx("div",{className:"py-6 sm:py-12 bg-zinc-50 min-h-screen",children:e.jsxs("div",{className:"mx-auto max-w-7xl px-4 sm:px-6",children:[e.jsxs("div",{className:"bg-white rounded-xl border border-zinc-200 shadow-sm p-6 mb-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-zinc-900",children:"Payment Reconciliation"}),e.jsx("p",{className:"text-zinc-500 mt-1",children:"Semak dan perbaiki status pembayaran yang tidak sepadan dengan ToyyibPay"})]}),e.jsx("button",{onClick:z,disabled:N,className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 font-medium",children:N?"Memproses...":"ðŸ”§ Auto-Repair All Pending"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-6",children:[e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[e.jsx("p",{className:"text-amber-800 font-medium",children:"Menunggu Bayaran"}),e.jsx("p",{className:"text-3xl font-bold text-amber-900",children:u.total_pending})]}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsx("p",{className:"text-green-800 font-medium",children:"Sudah Dibayar"}),e.jsx("p",{className:"text-3xl font-bold text-green-900",children:u.total_paid})]})]})]}),r&&e.jsx("div",{className:`rounded-xl border shadow-sm p-6 mb-6 ${r.error?"bg-red-50 border-red-200":"bg-green-50 border-green-200"}`,children:r.error?e.jsx("p",{className:"text-red-700",children:r.error}):e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"font-bold text-lg mb-3",children:"ðŸ“Š Hasil Auto-Repair"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-zinc-600 text-sm",children:"Disemak"}),e.jsx("p",{className:"text-2xl font-bold",children:r.checked})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-green-600 text-sm",children:"Diperbaiki"}),e.jsx("p",{className:"text-2xl font-bold text-green-700",children:r.fixed})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-red-600 text-sm",children:"Ralat"}),e.jsx("p",{className:"text-2xl font-bold text-red-700",children:r.errors?.length||0})]})]}),r.details&&r.details.length>0&&e.jsxs("details",{className:"mt-4",children:[e.jsx("summary",{className:"cursor-pointer text-zinc-600 hover:text-zinc-900",children:"Lihat Details"}),e.jsx("div",{className:"mt-2 bg-white rounded-lg p-4 max-h-60 overflow-y-auto",children:r.details.map((s,t)=>e.jsxs("div",{className:"flex justify-between items-center py-2 border-b last:border-0",children:[e.jsx("span",{children:s.child}),e.jsx("span",{className:s.action==="Fixed"?"text-green-600":"text-zinc-500",children:s.action})]},t))})]})]})}),e.jsxs("div",{className:"bg-white rounded-xl border border-zinc-200 shadow-sm",children:[e.jsx("div",{className:"border-b border-zinc-200",children:e.jsxs("div",{className:"flex",children:[e.jsxs("button",{onClick:()=>y("pending"),className:`px-6 py-4 font-medium transition-colors ${x==="pending"?"text-amber-700 border-b-2 border-amber-500 bg-amber-50":"text-zinc-500 hover:text-zinc-900"}`,children:["â³ Menunggu Bayaran (",m.length,")"]}),e.jsxs("button",{onClick:()=>y("paid"),className:`px-6 py-4 font-medium transition-colors ${x==="paid"?"text-green-700 border-b-2 border-green-500 bg-green-50":"text-zinc-500 hover:text-zinc-900"}`,children:["âœ… Sudah Dibayar (",p.length,")"]})]})}),e.jsxs("div",{className:"p-6",children:[x==="pending"&&e.jsx("div",{className:"overflow-x-auto",children:m.length===0?e.jsxs("div",{className:"text-center py-12 text-zinc-500",children:[e.jsx("p",{className:"text-4xl mb-4",children:"ðŸŽ‰"}),e.jsx("p",{children:"Tiada pembayaran pending yang perlu disemak!"})]}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-zinc-50",children:[e.jsx("th",{className:"text-left p-3",children:"Peserta"}),e.jsx("th",{className:"text-left p-3",children:"Penjaga"}),e.jsx("th",{className:"text-left p-3",children:"Pusat"}),e.jsx("th",{className:"text-left p-3",children:"Bill Code"}),e.jsx("th",{className:"text-left p-3",children:"Status ToyyibPay"}),e.jsx("th",{className:"text-right p-3",children:"Tindakan"})]})}),e.jsx("tbody",{children:m.map(s=>e.jsxs("tr",{className:"border-t border-zinc-100 hover:bg-zinc-50",children:[e.jsxs("td",{className:"p-3",children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-xs text-zinc-500",children:s.no_siri})]}),e.jsxs("td",{className:"p-3",children:[e.jsx("div",{children:s.parent_name}),e.jsx("div",{className:"text-xs text-zinc-500",children:s.parent_phone})]}),e.jsx("td",{className:"p-3 text-zinc-600",children:s.training_center}),e.jsx("td",{className:"p-3",children:e.jsx("code",{className:"bg-zinc-100 px-2 py-1 rounded text-xs",children:s.payment_reference})}),e.jsx("td",{className:"p-3",children:i[s.id]?e.jsx("div",{className:"text-sm",children:i[s.id].error?e.jsx("span",{className:"text-red-600",children:i[s.id].error}):e.jsxs("div",{children:[e.jsx("span",{className:i[s.id].toyyibpay_status==="Paid"?"text-green-600 font-medium":"text-amber-600",children:i[s.id].toyyibpay_status}),i[s.id].needs_update&&e.jsx("span",{className:"ml-2 bg-red-100 text-red-700 px-2 py-0.5 rounded text-xs",children:"Perlu perbaiki!"})]})}):e.jsx("span",{className:"text-zinc-400",children:"Belum disemak"})}),e.jsx("td",{className:"p-3 text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end flex-wrap",children:[e.jsx("button",{onClick:()=>k(s.id),disabled:j[s.id],className:"px-3 py-1.5 bg-zinc-100 text-zinc-700 rounded hover:bg-zinc-200 transition-colors text-sm disabled:opacity-50",children:j[s.id]?"...":"ðŸ” Semak"}),i[s.id]?.needs_update&&e.jsx("button",{onClick:()=>v(s.id),disabled:d[s.id],className:"px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-sm disabled:opacity-50",children:d[s.id]?"...":"âœ… Perbaiki"}),e.jsx("button",{onClick:()=>S(s.id,s.name),disabled:d[s.id],className:"px-3 py-1.5 bg-amber-500 text-white rounded hover:bg-amber-600 transition-colors text-sm disabled:opacity-50",title:"Manual fix dengan bukti pembayaran",children:d[s.id]?"...":"ðŸ”§ Manual Fix"})]})})]},s.id))})]})}),x==="paid"&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-zinc-50",children:[e.jsx("th",{className:"text-left p-3",children:"Peserta"}),e.jsx("th",{className:"text-left p-3",children:"No. Siri"}),e.jsx("th",{className:"text-left p-3",children:"Pusat"}),e.jsx("th",{className:"text-left p-3",children:"Bill Code"}),e.jsx("th",{className:"text-left p-3",children:"Tarikh Bayar"}),e.jsx("th",{className:"text-right p-3",children:"Jumlah"})]})}),e.jsx("tbody",{children:p.map(s=>e.jsxs("tr",{className:"border-t border-zinc-100 hover:bg-zinc-50",children:[e.jsx("td",{className:"p-3 font-medium",children:s.name}),e.jsx("td",{className:"p-3 text-zinc-600",children:s.no_siri}),e.jsx("td",{className:"p-3 text-zinc-600",children:s.training_center}),e.jsx("td",{className:"p-3",children:e.jsx("code",{className:"bg-green-100 px-2 py-1 rounded text-xs text-green-700",children:s.payment_reference})}),e.jsx("td",{className:"p-3 text-zinc-600",children:s.payment_date}),e.jsxs("td",{className:"p-3 text-right font-medium text-green-600",children:["RM ",s.registration_fee?.toFixed(2)||"-"]})]},s.id))})]})})]})]})]})})]})}export{A as default};
